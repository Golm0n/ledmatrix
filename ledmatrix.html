<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Missing Light — jeu matrice LED</title>
  <style>
    :root{--bg:#0f1724;--accent:#60a5fa;--ok:#10b981;--bad:#ef4444;--muted:#94a3b8;--cell-size:24px}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071025 0%,#081226 100%);color:#e6eef6;display:flex;justify-content:center;align-items:center}
    .wrap{max-width:900px;width:100%;padding:20px;text-align:center}
    h1{margin-bottom:6px;font-size:22px}
    .matrix{display:grid;gap:3px;justify-content:center;margin:20px auto;width:fit-content}
    .cell{width:var(--cell-size);height:var(--cell-size);border-radius:6px;background:rgba(255,255,255,0.05);cursor:pointer;transition:background .15s,box-shadow .15s}
    .cell.on{background:var(--accent);box-shadow:0 0 8px rgba(96,165,250,0.6)}
    .cell.correct{background:var(--ok);box-shadow:0 0 8px rgba(16,185,129,0.6)}
    .cell.wrong{background:var(--bad);box-shadow:0 0 8px rgba(239,68,68,0.6)}
    .hud{display:flex;justify-content:center;align-items:center;gap:12px;font-size:18px}
    .heart{color:var(--bad);font-size:22px}
    .heart.off{opacity:0.2}
    .controls{margin-top:12px}
    button{background:var(--accent);color:#04233b;border:none;padding:8px 14px;border-radius:10px;font-size:15px;cursor:pointer}
    button.hidden{display:none}
    .msg{margin-top:16px;font-size:18px}
    select,input{background:transparent;border:1px solid rgba(255,255,255,0.1);color:#e6eef6;padding:6px 8px;border-radius:8px}
    label{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Missing Light</h1>
  <div class="hud">
    <div id="hearts"></div>
    <div id="score">Score: 0</div>
  </div>
  <div class="controls">
    <label>Taille de grille :</label>
    <input id="gridSize" type="number" min="3" max="20" value="5" style="width:70px">&nbsp;
    <button id="startBtn">Démarrer</button>
    <button id="retryBtn" class="hidden">Rejouer</button>
  </div>
  <div id="matrix" class="matrix"></div>
  <div id="msg" class="msg"></div>
</div>

<script>
(function(){
  const matrixEl = document.getElementById('matrix');
  const startBtn = document.getElementById('startBtn');
  const retryBtn = document.getElementById('retryBtn');
  const msgEl = document.getElementById('msg');
  const heartsEl = document.getElementById('hearts');
  const scoreEl = document.getElementById('score');
  const gridSizeEl = document.getElementById('gridSize');

  let size = 10, num = 100, cells = [];
  let currentSeq = null;
  let phase = 'idle';
  let lives = 3, score = 0;
  let difficulty = 1;

  function buildGrid(n){
    size = n; num = n*n;
    matrixEl.innerHTML = '';
    matrixEl.style.gridTemplateColumns = `repeat(${n},1fr)`;
    const cellSize = Math.max(10, 300 / n);
    matrixEl.style.setProperty('--cell-size', `${cellSize}px`);
    cells = [];
    for(let i=0;i<num;i++){
      const d = document.createElement('div');
      d.className = 'cell';
      d.addEventListener('click', ()=>{
        if(phase==='guess') handleGuess(i);
      });
      matrixEl.appendChild(d);
      cells.push(d);
    }
  }

  function renderHearts(){
    heartsEl.innerHTML='';
    for(let i=0;i<3;i++){
      const span=document.createElement('span');
      span.textContent='❤';
      span.className='heart'+(i>=lives?' off':'');
      heartsEl.appendChild(span);
    }
  }

  function randInt(n){return Math.floor(Math.random()*n)}

  function genSequence(){
    const mode = (difficulty % 2 === 1) ? 'missing' : 'duplicate';
    const waves = Math.min(2 + Math.floor(difficulty/2), 5);
    const allIdx = Array.from({length:num},(_,i)=>i);
    let outWaves=[]; let target;

    if(mode==='missing'){
      const shuffled=[...allIdx].sort(()=>Math.random()-0.5);
      target = shuffled.pop();
      let chunkSize=Math.floor(shuffled.length/waves);
      for(let w=0;w<waves;w++) outWaves.push(shuffled.slice(w*chunkSize,(w+1)*chunkSize));
    } else {
      target=randInt(num);
      for(let w=0;w<waves;w++) outWaves.push([]);
      let w1=randInt(waves), w2=(w1+1)%waves;
      outWaves[w1].push(target); outWaves[w2].push(target);
      let pool=allIdx.filter(i=>i!==target).sort(()=>Math.random()-0.5);
      let p=0;
      for(let w=0;w<waves;w++){
        let count=Math.floor(num/(waves*1.5));
        for(let j=0;j<count && p<pool.length;j++) outWaves[w].push(pool[p++]);
      }
    }
    return {waves:outWaves,target,mode};
  }

  function clearCells(){cells.forEach(c=>c.className='cell');}

  async function playSequence(seq){
    phase='show';
    msgEl.textContent='Observe...';
    clearCells();
    let baseDur=1200 - difficulty*100;
    let dur=Math.max(400,baseDur);
    for(const wave of seq.waves){
      wave.forEach(i=>cells[i].classList.add('on'));
      await sleep(dur);
      wave.forEach(i=>cells[i].classList.remove('on'));
      await sleep(150);
    }
    phase='guess';
    msgEl.textContent=(seq.mode==='missing'?'Trouve la LED manquante':'Trouve la LED allumée deux fois');
  }

  function handleGuess(i){
    if(!currentSeq) return;
    if(i===currentSeq.target){
      cells[i].classList.add('correct');
      msgEl.textContent='Correct !';
      score++; scoreEl.textContent='Score: '+score;
      difficulty++;
      setTimeout(startRound,800);
    }else{
      cells[i].classList.add('wrong');
      cells[currentSeq.target].classList.add('correct');
      lives--; renderHearts();
      if(lives>0){
        msgEl.textContent='Raté ! Retente...';
        setTimeout(()=>playSequence(currentSeq),1000);
      }else{
        gameOver();
      }
    }
  }

  function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

  function startRound(){
    if(lives<=0) return;
    clearCells();
    currentSeq=genSequence();
    playSequence(currentSeq);
  }

  function startGame(){
    lives=3; score=0; difficulty=1;
    scoreEl.textContent='Score: 0';
    renderHearts();
    msgEl.textContent='';
    retryBtn.classList.add('hidden');
    startBtn.disabled=true;
    startRound();
  }

  function gameOver(){
    msgEl.textContent='Perdu ! Ton score : '+score;
    retryBtn.classList.remove('hidden');
    startBtn.disabled=false;
  }

  startBtn.addEventListener('click',()=>{
    buildGrid(parseInt(gridSizeEl.value,10));
    startGame();
  });
  retryBtn.addEventListener('click',()=>{
    buildGrid(parseInt(gridSizeEl.value,10));
    startGame();
  });

  function init(){
    buildGrid(size);
    renderHearts();
  }
  init();
})();
</script>
</body>
</html>